{% extends 'admin/master.html' %}

{% block body %}
<h1 class="text-center text-info">BÁO CÁO TỔNG KẾT MÔN HỌC</h1>
<br>
<form action="" method="GET" style="display: flex; flex-direction: column; align-items: center;">
    <div style="display: flex; justify-content: space-between; width: 100%;">
        <div>
            <label for="subject_id">Môn học:</label>
            <select class="form-select" id="subject_id" name="subject_id">
                {% for subject_id in subjects %}
                <option value="{{ subject_id }}">{{ subject_id }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="semester">Học kỳ:</label>
            <select class="form-select" id="semester" name="semester">
                <option value="SEMESTER_1">Học kỳ 1</option>
                <option value="SEMESTER_2">Học kỳ 2</option>
            </select>
        </div>
        <div>
            <label for="year">Năm học:</label>
            <select class="form-select" id="year" name="year">
                {% for year in years %}
                <option value="{{ year }}">{{ year }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <br>
    <button type="submit" class="btn btn-success">Thống kê</button>
</form>
<br>
<div class="row">
    <div class="col-md-5">
        <table class="table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Lớp</th>
                    <th>Sĩ số</th>
                    <th>Số lượng đạt</th>
                    <th>Tỷ lệ (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in stats %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ stat[1][1] }}</td>
                    <td>{{ stat[1][2] }}</td>
                    <td>{{ stat[1][3] if stat[1][3] is not none else 0 }}</td>
                    <td>{{ "%.2f" | format(stat[1][4]) if stat[1][4] is not none else 0 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="col-md-7">
        <canvas id="myChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Prepare data for the chart
  let data = [];
  let labels = [];

  {% for stat in stats %}
  data.push({{ stat[1][4] if stat[1][4] is not none else 0 }});
  labels.push('{{ stat[1][1] }}');
  {% endfor %}

  window.onload = function() {
      const ctx = document.getElementById('myChart');

      new Chart(ctx, {
          type: 'bar',
          data: {
              labels: labels,
              datasets: [{
                  label: 'Tỷ lệ đạt (%)',
                  data: data,
                  backgroundColor: 'blue'
              }]
          },
          options: {
              scales: {
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });
  }
</script>
{% endblock %}
